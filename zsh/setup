#!/usr/bin/env bash

mkdir -p "$HOME/.local/bin"
mkdir -p "$HOME/.local/scripts"
mkdir -p "$HOME/.config"
mkdir -p "$HOME/projects"

command_exists() {
  command -v "$1" >/dev/null 2>&1
}

create_symlink() {
  local src=$1
  local dst=$2
  [ -L "$dst" ] && rm "$dst"
  [ -e "$dst" ] && [ ! -L "$dst" ] && mv "$dst" "$dst.bak"
  ln -sfv "$src" "$dst"
}

detect_os_and_package_manager() {
  local os
  os=$(uname -s)

  if [ "$os" = "Darwin" ]; then
    OS="macos"
    if ! command_exists brew; then
      echo "Homebrew not found. Please install it first."
      exit 1
    fi
    PACKAGE_MANAGER="brew"
    return
  fi

  [ "$os" != "Linux" ] && {
    echo "Unsupported OS: $os"
    exit 1
  }

  OS="linux"
  local distro=""

  if command_exists lsb_release; then
    distro=$(lsb_release -d | awk '{print tolower($2)}')
  elif [ -f /etc/os-release ]; then
    . /etc/os-release
    distro=$ID
  fi

  case "$distro" in
  ubuntu | debian)
    PACKAGE_MANAGER="apt"
    ;;
  arch)
    PACKAGE_MANAGER="pacman"
    ;;
  fedora | ol | oracle | rhel | centos | almalinux | rocky)
    PACKAGE_MANAGER="dnf"
    ;;
  *)
    echo "Unsupported Linux distribution: $distro"
    exit 1
    ;;
  esac
}

install_packages() {
  if [ -z "$PACKAGE_MANAGER" ]; then
    echo "Package manager not set."
    exit 1
  fi

  case "$PACKAGE_MANAGER" in
  brew)
    if ! command -v brew &>/dev/null; then
      echo "Homebrew not found. Installing Homebrew..."
      /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
    fi

    echo >>$HOME/.zprofile
    echo 'eval "$(/opt/homebrew/bin/brew shellenv)"' >>$HOME/.zprofile
    eval "$(/opt/homebrew/bin/brew shellenv)"

    # Update Homebrew
    echo "Updating Homebrew..."
    brew update
    brew install pipx neovim tmux bat zsh fd colima neofetch ripgrep python3-pip git go
    brew install koekeishiya/formulae/skhd
    brew install koekeishiya/formulae/yabai
    brew install yqrashawn/goku/goku
    brew tap FelixKratz/formulae
    brew install duckdb
    brew install borders
    brew install --cask font-jetbrains-mono-nerd-font
    brew install font-lxgw-wenkai
    brew install --cask syncthing
    brew install --cask skim
    brew install --cask discord
    brew install --cask zoom
    brew install --cask obsidian
    brew install --cask google-chrome
    brew install --cask logi-options+
    brew install --cask visual-studio-code
    brew install --cask v2rayu
    brew install --cask wechat
    brew install --cask whatsapp
    brew install --cask raycast
    brew install --cask mos
    brew install --cask betterdisplay
    brew install --cask maccy
    brew install --cask dropbox
    brew install onedrive
    brew install --cask microsoft-outlook
    brew install --cask microsoft-word
    brew install --cask karabiner-elements
    brew install pomdtr/tap/ray
    brew install --cask google-drive
    defaults write -g InitialKeyRepeat -int 10
    defaults write -g KeyRepeat -int 1
    curl -L https://sw.kovidgoyal.net/kitty/installer.sh | sh /dev/stdin installer=version-0.40.0
    sudo ln -sf /Applications/kitty.app/Contents/MacOS/kitty /usr/local/bin/kitty
    curl -fsSL https://deno.land/install.sh | sh
    ;;
  apt)
    sudo apt update
    sudo apt upgrade -y
    sudo apt-get install -y tmux unzip neovim vim neofetch ripgrep tldr tree zoxide direnv pipx fd-find python3-pip zsh git golang-go --ignore-missing
    sudo apt-get install -y build-essential libssl-dev zlib1g-dev libbz2-dev \
      libreadline-dev libsqlite3-dev wget curl llvm libncurses5-dev libncursesw5-dev \
      xz-utils tk-dev libffi-dev liblzma-dev python3-openssl git
    create_symlink "$(which fdfind)" "$HOME/.local/bin/fd"
    curl -fsSL https://deno.land/install.sh | sh
    ;;
  dnf)
    sudo dnf update -y

    # Install basic build tools (needed for pyenv and go compilation)
    sudo dnf groupinstall -y "Development Tools"
    sudo dnf install -y openssl-devel bzip2-devel libffi-devel zlib-devel readline-devel sqlite-devel

    # Enable COPR for specific tools if needed (Optional, usually safe on OL)
    sudo dnf copr enable pennbauman/ports -y

    # Note: On RHEL/OL 'fd' is often named 'fd-find' inside EPEL
    sudo dnf install -y pipx unzip neovim vim tmux bat zsh fd-find ripgrep htop tldr zoxide cloc python3-pip git lf golang --skip-unavailable

    # Symlink fd-find to fd if necessary
    if command -v fdfind &>/dev/null; then
      create_symlink "$(which fdfind)" "$HOME/.local/bin/fd"
    fi

    curl -fsSL https://deno.land/install.sh | sh
    ;;
  esac
}

#### Main Script Execution Starts ####

echo "Download essential dependencies..."
detect_os_and_package_manager
install_packages

echo "Cloning the repository..."
if [ ! -d "dotfiles" ]; then
  git clone https://github.com/sokinpui/terminal_dotfiles.git dotfiles
fi
cd dotfiles

echo "Detected OS: $OS with package manager: $PACKAGE_MANAGER"

echo "Installation of dependencies complete!"

REPO_DIR="$(pwd)"
CONFIG_DIR="$HOME/.config"

echo "Repository directory: $REPO_DIR"
echo "Configuration directory: $CONFIG_DIR"

mkdir -p "$CONFIG_DIR"

echo "Creating symbolic links for configuration files..."

# Note: Kitty might fail on a headless VPS, removed from auto-link if strictly headless,
# but kept here for consistency with your dotfiles.
DOTFILES=(nvim AutoRaise tmux kitty bat lf skhd yabai yazi)

for tool in "${DOTFILES[@]}"; do
  [ ! -e "$REPO_DIR/$tool" ] && {
    echo "Warning: $tool not found, skipping."
    continue
  }
  create_symlink "$REPO_DIR/$tool" "$CONFIG_DIR/$tool"
done

echo "Symbolic linking complete! Please check the links and start your terminal tools."

create_symlink "$REPO_DIR/zsh" "$CONFIG_DIR/zsh"

echo "Creating symbolic links for zsh configuration files..."
create_symlink "$REPO_DIR/zsh/.zshrc" "$HOME/.zshrc"
create_symlink "$REPO_DIR/zsh/.zshenv" "$HOME/.zshenv"
create_symlink "$REPO_DIR/zsh/.zprofile" "$HOME/.zprofile"

pipx install neovim-remote
pipx install trash-cli
# Added checks for pip3 break-system-packages flag which is only valid on newer python versions
if pip3 install --help | grep -q "break-system-packages"; then
  pip3 install pynvim --break-system-packages
else
  pip3 install pynvim
fi

create_symlink "$REPO_DIR/gitignore_global" "$HOME/.gitignore_global"
git config --global core.excludesfile "$HOME/.gitignore_global"

mkdir -p "$HOME/.local"
create_symlink "$REPO_DIR/scripts" "$HOME/.local/scripts"

# Ensure Go bin is in path for the installation of tools
export PATH=$PATH:$(go env GOPATH)/bin

go install github.com/sokinpui/wt-go/cmd/wtgo@latest
go install github.com/sokinpui/itf/cmd/itf@latest
go install github.com/sokinpui/pcat/cmd/pcat@latest
env CGO_ENABLED=0 go install -ldflags="-s -w" github.com/gokcehan/lf@latest

git clone --depth 1 https://github.com/junegunn/fzf.git ~/.fzf
~/.fzf/install --all

echo "Setup complete! Please restart your shell."
